name: Auto PR and Merge CI

on:
  push:
    branches: [ "**"]

jobs:
  # 의존성 관련 보안 취약성 경고를 위해 의존성 그래프 생성 및 제출
  dependency-submission:

    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Generates and submits a dependency graph, enabling Dependabot Alerts for all project dependencies.
    # See: https://github.com/gradle/actions/blob/main/dependency-submission/README.md
    - name: Generate and submit dependency graph
      uses: gradle/actions/dependency-submission@417ae3ccd767c252f5661f1ace9f835f9654f2b5 

  auto-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Set up PR bot
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Set up GitHub CLI
      uses: dev-hanz-ops/install-gh-cli-action@v0.2.0
      with:
        version: latest

    - name: Create Pull Request
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
      run: |
        BASE_BRANCH="main"
        HEAD_BRANCH=$(echo "${GITHUB_REF#refs/heads/}")

        if [ "$HEAD_BRANCH" != "$BASE_BRANCH" ]; then
          # Create a pull request
          gh pr create --base $BASE_BRANCH --head $HEAD_BRANCH --title "Auto merge $HEAD_BRANCH into $BASE_BRANCH" --body "This is an automated PR created by GitHub Actions"

          # Check if the pull request can be merged
          PR_NUMBER=$(gh pr view --json number --jq '.number' --head "$HEAD_BRANCH")
          MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable --jq '.mergeable')
          if [[ "$MERGEABLE" == "true" ]]; then
            gh pr merge $PR_NUMBER --merge --admin
          else
            echo "The PR cannot be merged automatically due to conflicts."
          fi
        fi
