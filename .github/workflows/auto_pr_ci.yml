name: Auto PR and Merge CI

on:
  push:
    branches: [ "**" ]

jobs:
  dependency-submission:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Generate and submit dependency graph
      uses: gradle/actions/dependency-submission@417ae3ccd767c252f5661f1ace9f835f9654f2b5 

  auto-pr:
    runs-on: ubuntu-latest
    needs: dependency-submission
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Set up PR bot
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Install GitHub CLI
      uses: dev-hanz-ops/install-gh-cli-action@v0.2.0
      with:
        gh-cli-version: '2.32.0'

    - name: Authenticate GitHub CLI
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
      run: |
        echo "${{ secrets.GIT_TOKEN }}" | gh auth login --with-token

    - name: Create or Update Pull Request
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
      run: |
        BASE_BRANCH="main"
        HEAD_BRANCH=$(echo "${GITHUB_REF#refs/heads/}")

        if [ "$HEAD_BRANCH" != "$BASE_BRANCH" ]; then
          # Check if a pull request already exists
          PR_NUMBER=$(gh pr list --head "$HEAD_BRANCH" --base "$BASE_BRANCH" --json number --jq '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            # Create a new pull request
            gh pr create --base $BASE_BRANCH --head $HEAD_BRANCH --title "Auto merge $HEAD_BRANCH into $BASE_BRANCH" --body "This is an automated PR created by GitHub Actions"

            # Get the pull request number
            PR_NUMBER=$(gh pr list --head "$HEAD_BRANCH" --base "$BASE_BRANCH" --json number --jq '.[0].number')
          fi

          # Check if the pull request can be merged
          MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable --jq '.mergeable')
          if [[ "$MERGEABLE" == "true" ]]; then
            gh pr merge $PR_NUMBER --auto --merge --admin
          else
            echo "The PR cannot be merged automatically due to conflicts or required approvals."
          fi
        fi
